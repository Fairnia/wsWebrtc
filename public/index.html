<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <div class="usernameForm" style="
      margin: 20px auto;
      font-size: 25px;
      max-width: 300px;
      display: flex;
      justify-content: center;
      flex-direction: column;">
      <label >Username:</label><br>
      <!-- make sure usernames can only be letters and numbers (maybe just use text replace) -->
      <input type="text" id="usernameInput" value="Human"><br>
      <button onclick="connect()">Connect</button>
      <button onclick="block()" style="
        margin: 20px auto;">Block</button>
      <button onclick="disconnect()">Disconnect</button>
      <div style='padding-top:9px;'>
        <div id="newPartner">
          Hey <span id='userName'></span>, meet <span id='partnerName'></span>
        </div>
        <div id="findingPartner">
          Finding you a new partner...
        </div>
        <div id="userId"></div>
        <div class="prevPartners">
          Previous users: <span id='prevUsersArray'></span>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      document.getElementById("usernameInput").select()
      // Get our hostname
      var myHostname = window.location.hostname;
      if (!myHostname) {
      myHostname = "localhost";
      }
      console.log("Hostname: " + myHostname);

      // Need to build a function that checks local storage if username has been selected
      // and to give the user an option to change their username
      //populate the username and partnername fields

      var newPartnerel = document.getElementById('newPartner');
      newPartnerel.style.display = "none";
      var findingPartnerel = document.getElementById('findingPartner');
      findingPartnerel.style.display = "none";
      var userIdel = document.getElementById('userId');
      var prevUsersArrayel = document.getElementById('prevUsersArray');
      var connection = null;
      var partnerName = document.getElementById('partnerName');
      var myId;
      var partnerId;

      function connect() {
        var usernameInput = document.getElementById('usernameInput').value;
        var username = document.getElementById('userName');
        var serverUrl;
        var scheme = "ws";
        if (document.location.protocol === "https:") {
          scheme += "s";
        }
        serverUrl = scheme + "://" + myHostname + ":4500";

        console.log(`Connecting to server: ${serverUrl}`);
        connection = new WebSocket(serverUrl, "json");

        connection.onerror = function(evt) {
          console.dir(evt);
        }
        connection.onopen = function(evt) {
          //send username asap, once connection as been made
          sendToServer({
            text: usernameInput,
            type: "username"
          });
        };
        connection.onmessage = function(evt) {
          var msg = JSON.parse(evt.data);
          console.log("Message received: ");
          console.dir(msg);

          switch(msg.type) {
            case "id":
              myId = msg.id
              userIdel.innerText = myId;
              console.log('id');
              break;
            case "matched":
              console.log('matched!')
              console.log("user1 is ", msg.user1);
              console.log("user2 is ", msg.user2);
              if(msg.user1.id === myId){
                partnerId = msg.user2.id
                username.innerText = msg.user1.username;
                partnerName.innerText = msg.user2.username
                prevUsersArrayel.innerText = msg.user1.prevMatched
              }else{
                partnerId = msg.user1.id
                username.innerText = msg.user2.username;
                partnerName.innerText = msg.user1.username
                prevUsersArrayel.innerText = msg.user2.prevMatched
              }
              findingPartnerel.style.display = "none"
              newPartnerel.style.display = "block"
              setTimeout(()=>{
                findNewPartner(myId)
              },6000)
              //user1 will always disconnect
              break;
            case "matching":
              partnerId = '';
              findingPartnerel.style.display = "block"
              newPartnerel.style.display = "none"
            break;
            case "banned":
              window.location.href = "/banned.html";
              connection.close();
            break;
            // Unknown message; output to console for debugging.
            default:
              console.log("Unknown message received:");
              console.log('unknown message on refresh');
              console.dir(msg, { depth: null });
              //log_error(msg);
            }
          };
          function findNewPartner(id){
            sendToServer({
              name: myId,
              type: "find-new-parnter"
            });
            partnerId = null;
          }
      }

      function handleHangUpMsg(msg) {
        console.log("*** Received hang up notification from other peer");
        //close video call is for webrtc
        //closeVideoCall();
      }

      function disconnect() {
        //close video call is for webrtc
       closeVideoCall();
       window.location.href = "/thankyou.html";
       connection.close();

       //don't think I'll need the hang-up send to server bc it'll be here
       //might need to match ip address or device id to id in order to make sure there's no hacking into other people's "accounts"
        // sendToServer({
        //   name: myID,
        //   target: partnerId,
        //   type: "hang-up"
        // });
      }

      function block(){
        sendToServer({
          userId: myId,
          partnerId: partnerId,
          type: "block"
        });
        console.log('partnerId ', partnerId)
      }

      function sendToServer(msg) {
        var msgJSON = JSON.stringify(msg);

        console.log("Sending '" + msg.type + "' message: " + msgJSON);
        if(connection){
          connection.send(msgJSON);
        }
      }
    </script>
  </body>
</html>
